# CVE-2019-1215 : ws2ifsl.sys Use After Free Vulnerlability

## Backgrounds : ws2ifsl.sys

WinSocket과 관련된 드라이버이다.

사용자는 다음과 같은 형태로 ws2ifsl 드라이버 dipatch 루틴을 호출할 수 있다.

1. `filename` 인자를 `"\\Device\\WS2IFSL\\"`으로 설정하여 `NtOpenFile` 호출.
2. `DispatchCreate` 호출
3. `_FILE_FULL_EA_INFORMATION.EaName`의 값에 따라 2개 분기로 나뉜다. 
(1) `NifsPvd`일 경우, `CreateProcessFile` 호출 (2) `NifsSct`일 경우, `CreateSocketFile` 호출

여기서, `CreateProcessFile`과 `CreateSocketFile`은 각각 `procData`와 `socketData` 오브젝트를 생성한다.

이렇게 생성된 오브젝트는 `_FILE_OBJECT.FsContext`에 저장되며, 사용자는 `NtCreateFile`가 반환한 file object를 통해 이들 오브젝트에 접근할 수 있다.
더불어, (`NtCreateFile`이)반환한 handle은 `DeviceIoControl` 또는 `WriteFile` API에 사용될 수 있다. 

여기서 주목할만한 점은 file 오브젝트는 `ObfReferenceObject`와 `ObfDereferenceObject`에 의해 reference count가 관리되지만, 
`procData`와 `socketData` 오브젝트는 그렇지 않다는 점이다.


## Root Cause Analysis






