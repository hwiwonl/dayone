# CVE-2019-1215 : ws2ifsl.sys Use After Free Vulnerlability


## Version Information

* Vulnerable version : 
* Patched version : 10.0.18362.356.

## Backgrounds : ws2ifsl.sys

`ws2ifsl.sys`는 WinSocket과 관련된 드라이버로서, 내부에서 관리되는 오브젝트가 크게 2가지 존재한다.

다음으로, 공격자가 `ws2ifsl.sys`를 공격 벡터로 활용하기 위한 조건인데, 사용자는 다음과 같은 형태로 ws2ifsl 드라이버의 dipatch 루틴을 호출할 수 있다.

1. `filename` 인자를 `"\\Device\\WS2IFSL\\"`으로 설정하여 `NtOpenFile` 호출.
2. `DispatchCreate` 호출
3. `_FILE_FULL_EA_INFORMATION.EaName`의 값에 따라 2개 분기로 나뉜다. 
(1) `NifsPvd`일 경우, `ws2ifsl!CreateProcessFile` 호출 (2) `NifsSct`일 경우, `ws2ifsl!CreateSocketFile` 호출

여기서, `CreateProcessFile`과 `CreateSocketFile`은 각각 `procData`와 `socketData` 오브젝트를 생성한다.

이렇게 생성된 오브젝트는 `_FILE_OBJECT.FsContext`에 저장되며, 사용자는 `NtCreateFile`가 반환한 file object를 통해 이들 오브젝트에 접근할 수 있다.
더불어, (`NtCreateFile`이)반환한 handle은 `DeviceIoControl` 또는 `WriteFile` API에 사용될 수 있다. 

여기서 주목할만한 점은 file 오브젝트는 `ObfReferenceObject`와 `ObfDereferenceObject`에 의해 reference count가 관리되지만, 
`procData`와 `socketData` 오브젝트는 그렇지 않다는 점이다.

또한, `ws2ifsl.sys`는 2개의 APC(Asynchronous Procedure Call) 오브젝트를 관리하는데, 각각 `request queue`와 `cancel queue`로 구성된다.
APC는 다른 thread의 함수를 비동기적으로 실행시키기 위한 방법인데, 하나의 thread에 대해 다수의 APC가 요청될 수 있으므로,
커널은 APC가 실행될 순서인 queue를 마련하여 관리한다.

`procData` 오브젝트는 이러한 2개 APC 오브젝트(`request queue` & `cancel queue`)를 담고 있는데, 이들은 각각 `InitializeRequestQueue()`와  `InitializeCancelQueue()`가 `CreateProcessFile()`에서 호출됨과 동시에 초기화된다.


## Root Cause Analysis

`procData` handle을 생성하고, 




